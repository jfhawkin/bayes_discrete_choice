library(rstan) # observe startup messages
library(dplyr)
library(dummies)
rstan_options(auto_write = TRUE)

dat = read.csv('https://raw.githubusercontent.com/jfhawkin/bayes_discrete_choice/master/xmatswave2019.csv',header = FALSE)
# dat = cbind(dat, dummy(dat$ALT, sep = "_"))

# We have 8 tasks per individual for 184 individuals comparing 4 alternatives
I = 184 # Number of individuals
C = 424 # Number of data columns
K = 4   # Number of alternatives in each choice task
T = 8 # Number of alternatives by number of choice tasks
P1 = 3  # Number of variables for alternative 1
P2 = 3  # Number of variables for alternative 2
P3 = 3  # Number of variables for alternative 3
P4 = 3  # Number of variables for alternative 4
PR = 4 # We'll vary one choice attribute for each alternative at each task

X = data.matrix(dat)

# Scale additional costs/monthly mileage to $1000/1000 mi
X[,71] = X[,71] / 1000
X[,73] = X[,73] / 1000
X[,102] = X[,102] / 1000
X[,104] = X[,104] / 1000
X[,116] = X[,116] / 1000
X[,118] = X[,118] / 1000
X[,147] = X[,147] / 1000
X[,149] = X[,149] / 1000
X[,160] = X[,160] / 1000
X[,161] = X[,161] / 1000
X[,163] = X[,163] / 1000
X[,192] = X[,194] / 1000
X[,205] = X[,205] / 1000
X[,206] = X[,206] / 1000
X[,208] = X[,208] / 1000
X[,237] = X[,237] / 1000
X[,251] = X[,251] / 1000
X[,253] = X[,253] / 1000
X[,284] = X[,284] / 1000
X[,295] = X[,295] / 1000
X[,296] = X[,296] / 1000
X[,298] = X[,298] / 1000
X[,312] = X[,312] / 1000
X[,327] = X[,327] / 1000
X[,340] = X[,340] / 1000
X[,341] = X[,341] / 1000
X[,343] = X[,343] / 1000
X[,372] = X[,371] / 1000
X[,374] = X[,374] / 1000
X[,385] = X[,385] / 1000
X[,386] = X[,386] / 1000
X[,388] = X[,388] / 1000
X[,417] = X[,417] / 1000
X[,419] = X[,419] / 1000
X[,87] =  X[,87] / 1000
X[,134] = X[,134] / 1000
X[,160] = X[,160] / 1000
X[,179] = X[,179] / 1000
X[,222] = X[,222] / 1000
X[,267] = X[,267] / 1000
X[,357] = X[,357] / 1000
X[,402] = X[,402] / 1000
# Scale monthly parking
X[,90] = X[,90] / 100
X[,91] = X[,91] / 100
X[,93] = X[,93] / 100
X[,97] = X[,97] / 100
X[,135] = X[,135] / 100
X[,136] = X[,136] / 100
X[,138] = X[,138] / 100
X[,142] = X[,142] / 100
X[,180] = X[,180] / 100
X[,181] = X[,181] / 100
X[,183] = X[,183] / 100
X[,187] = X[,187] / 100
X[,224] = X[,224] / 100
X[,225] = X[,225] / 100
X[,226] = X[,226] / 100
X[,228] = X[,228] / 100
X[,232] = X[,232] / 100
X[,269] = X[,269] / 100
X[,270] = X[,270] / 100
X[,271] = X[,271] / 100
X[,273] = X[,273] / 100
X[,277] = X[,277] / 100
X[,315] = X[,315] / 100
X[,316] = X[,316] / 100
X[,318] = X[,318] / 100
X[,322] = X[,322] / 100
X[,359] = X[,359] / 100
X[,360] = X[,360] / 100
X[,361] = X[,361] / 100
X[,363] = X[,363] / 100
X[,367] = X[,367] / 100
X[,405] = X[,405] / 100
X[,406] = X[,406] / 100
X[,408] = X[,408] / 100
X[,412] = X[,412] / 100

choice = matrix(0L, nrow = I, ncol = T*K)
for(i in 1:T){
  for (j in 1:K){
    choice[,j+(i-1)*K] = as.integer(X[,49+(i-1)]==j)
  }
}
  

data_list = list(I = I,
                  C = C,
                  K = K,
                  T = T,
                  P1 = P1, 
                  P2 = P2,
                  P3 = P3, 
                  P4 = P4,
                  PR = PR,
                  X = X,
                  choice = choice
                  )

# Compile the model
compiled_model = stan_model("kaili_stan.stan")

# Fit the model
model_fit = sampling(compiled_model, data = data_list, iter = 2000, cores=4)

sampler_params = get_sampler_params(model_fit, inc_warmup = TRUE)
summary(do.call(rbind, sampler_params), digits = 2)
print(model_fit)

# Inference for Stan model: kaili_stan.
# 4 chains, each with iter=2000; warmup=1000; thin=1; 
# post-warmup draws per chain=1000, total post-warmup draws=4000.
# 
# mean se_mean    sd     2.5%      25%      50%      75%    97.5% n_eff Rhat
# beta1[1]                   0.51    0.00  0.17     0.18     0.40     0.51     0.63     0.84  3297    1
# beta1[2]                   0.01    0.00  0.01    -0.01     0.00     0.01     0.02     0.03  4184    1
# beta1[3]                  -0.22    0.00  0.10    -0.42    -0.29    -0.22    -0.16    -0.03  3261    1
# beta2[1]                  -0.03    0.00  0.01    -0.04    -0.03    -0.03    -0.02    -0.01  5492    1
# beta2[2]                  -0.09    0.00  0.01    -0.10    -0.09    -0.09    -0.08    -0.07  2574    1
# beta2[3]                   0.66    0.00  0.11     0.45     0.58     0.66     0.74     0.88  2178    1
# beta3[1]                  -0.13    0.00  0.02    -0.17    -0.14    -0.13    -0.12    -0.09  2197    1
# beta3[2]                  -0.29    0.03  1.51    -3.35    -1.25    -0.22     0.69     2.63  3024    1
# beta3[3]                  -6.40    0.04  2.62   -11.52    -8.17    -6.38    -4.57    -1.35  3956    1
# beta4[1]                  -0.47    0.00  0.10    -0.67    -0.54    -0.47    -0.40    -0.27  3113    1
# beta4[2]                  -0.03    0.00  0.01    -0.05    -0.04    -0.03    -0.03    -0.02  2210    1
# beta4[3]                  -0.44    0.00  0.10    -0.64    -0.51    -0.44    -0.38    -0.25  1806    1
# betar[1]                  -4.15    0.01  0.34    -4.82    -4.38    -4.15    -3.92    -3.51  1781    1
# betar[2]                  -0.49    0.00  0.10    -0.68    -0.55    -0.49    -0.42    -0.30  2358    1
# betar[3]                  -0.01    0.00  0.07    -0.14    -0.05    -0.01     0.04     0.12  5324    1
# betar[4]                   0.05    0.00  0.11    -0.16    -0.02     0.05     0.13     0.25  2855    1
# tau[1]                     0.44    0.00  0.15     0.19     0.32     0.42     0.53     0.76  1545    1
# tau[2]                     0.08    0.00  0.01     0.05     0.07     0.07     0.08     0.10  6084    1
# tau[3]                     0.08    0.00  0.01     0.05     0.07     0.08     0.08     0.10  5014    1
# tau[4]                     0.12    0.00  0.02     0.08     0.10     0.11     0.13     0.17  5933    1
# z[1,1]                     0.30    0.01  0.93    -1.61    -0.31     0.31     0.91     2.09  7553    1
# z[1,2]                     0.06    0.01  0.95    -1.79    -0.57     0.07     0.71     1.93  6682    1
# z[1,3]                     0.08    0.01  0.95    -1.78    -0.55     0.09     0.71     1.94  6669    1
# z[1,4]                     0.16    0.01  0.98    -1.75    -0.50     0.16     0.81     2.09  7139    1
# z[2,1]                     0.57    0.01  0.95    -1.33    -0.07     0.58     1.23     2.43  7157    1
# z[2,2]                     0.30    0.01  0.98    -1.57    -0.36     0.30     0.97     2.21  7488    1
# z[2,3]                    -0.01    0.01  0.95    -1.91    -0.64     0.00     0.63     1.86  8165    1
# z[2,4]                    -0.09    0.01  0.99    -2.01    -0.77    -0.08     0.59     1.86  7831    1
# z[3,1]                    -0.30    0.01  0.93    -2.11    -0.93    -0.30     0.34     1.55  7905    1
# z[3,2]                    -0.05    0.01  0.99    -1.94    -0.72    -0.05     0.65     1.86  9720    1
# z[3,3]                    -0.11    0.01  0.97    -2.01    -0.77    -0.13     0.55     1.76  6577    1
# z[3,4]                    -0.06    0.01  0.97    -1.93    -0.71    -0.06     0.57     1.88  8159    1
# z[4,1]                    -0.29    0.01  0.93    -2.15    -0.91    -0.28     0.33     1.55  6818    1
# z[4,2]                    -0.09    0.01  0.98    -1.99    -0.75    -0.09     0.59     1.80  9232    1
# z[4,3]                     0.17    0.01  0.97    -1.75    -0.50     0.18     0.81     2.02  8016    1
# z[4,4]                     0.12    0.01  0.98    -1.82    -0.54     0.12     0.76     2.00  7069    1
# z[5,1]                     0.44    0.01  0.93    -1.42    -0.16     0.45     1.09     2.20  7478    1
# z[5,2]                    -0.11    0.01  0.97    -2.00    -0.74    -0.13     0.53     1.80  9211    1
# z[5,3]                     0.06    0.01  0.94    -1.79    -0.57     0.04     0.70     1.90  7435    1
# z[5,4]                    -0.04    0.01  0.96    -1.96    -0.70    -0.04     0.62     1.83  7259    1
# z[6,1]                    -0.31    0.01  0.95    -2.15    -0.95    -0.31     0.33     1.60  8131    1
# z[6,2]                    -0.05    0.01  0.96    -1.87    -0.70    -0.07     0.59     1.82  6965    1
# z[6,3]                    -0.10    0.01  0.99    -2.03    -0.80    -0.12     0.61     1.87  7773    1
# z[6,4]                    -0.05    0.01  0.99    -2.00    -0.70    -0.05     0.60     1.87  7663    1
# z[7,1]                     0.42    0.01  0.94    -1.42    -0.22     0.44     1.06     2.22  7254    1
# z[7,2]                    -0.09    0.01  0.93    -1.83    -0.75    -0.09     0.55     1.68  8662    1
# z[7,3]                     0.06    0.01  0.96    -1.84    -0.58     0.06     0.70     1.94  7967    1
# z[7,4]                    -0.05    0.01  0.98    -1.98    -0.71    -0.03     0.63     1.79  6219    1
# z[8,1]                     0.45    0.01  0.93    -1.45    -0.17     0.46     1.06     2.21  7392    1
# z[8,2]                     0.13    0.01  0.96    -1.79    -0.51     0.13     0.76     1.95  7611    1
# z[8,3]                     0.14    0.01  0.95    -1.70    -0.51     0.15     0.78     1.96  8042    1
# z[8,4]                     0.19    0.01  0.99    -1.70    -0.49     0.19     0.86     2.14  7985    1
# z[9,1]                     0.16    0.01  0.96    -1.73    -0.48     0.17     0.81     2.08  7624    1
# z[9,2]                    -0.05    0.01  0.96    -1.94    -0.71    -0.06     0.60     1.87  7559    1
# z[9,3]                     0.26    0.01  0.97    -1.65    -0.37     0.27     0.89     2.16  7227    1
# z[9,4]                     0.22    0.01  0.96    -1.70    -0.44     0.22     0.87     2.06  7051    1
# z[10,1]                    0.53    0.01  0.97    -1.36    -0.15     0.53     1.21     2.45  6996    1
# z[10,2]                    0.16    0.01  0.96    -1.62    -0.50     0.15     0.80     2.07  7888    1
# z[10,3]                    0.04    0.01  0.96    -1.84    -0.57     0.05     0.67     1.96  6888    1
# z[10,4]                    0.10    0.01  0.98    -1.82    -0.57     0.10     0.79     1.98  8187    1
# z[11,1]                    0.02    0.01  0.91    -1.84    -0.60     0.03     0.65     1.74  7406    1
# z[11,2]                    0.15    0.01  0.97    -1.80    -0.50     0.16     0.81     2.05  7981    1
# z[11,3]                   -0.12    0.01  0.96    -2.01    -0.78    -0.12     0.52     1.76  7085    1
# z[11,4]                   -0.19    0.01  0.94    -2.03    -0.81    -0.19     0.43     1.61  7601    1
# z[12,1]                   -0.30    0.01  0.97    -2.14    -0.98    -0.29     0.36     1.59  6213    1
# z[12,2]                   -0.05    0.01  0.96    -1.94    -0.70    -0.05     0.62     1.83  7347    1
# z[12,3]                   -0.10    0.01  0.97    -2.00    -0.74    -0.10     0.55     1.78  7428    1
# z[12,4]                   -0.07    0.01  0.98    -1.95    -0.73    -0.08     0.58     1.83  9181    1
# z[13,1]                    0.43    0.01  0.94    -1.40    -0.20     0.44     1.08     2.25  7239    1
# z[13,2]                   -0.11    0.01  0.95    -1.90    -0.74    -0.12     0.54     1.77  8337    1
# z[13,3]                    0.08    0.01  0.99    -1.90    -0.59     0.09     0.76     1.95  8903    1
# z[13,4]                   -0.06    0.01  0.96    -1.97    -0.70    -0.04     0.59     1.82  6967    1
# z[14,1]                    0.23    0.01  0.96    -1.67    -0.42     0.24     0.88     2.05  6996    1
# z[14,2]                    0.03    0.01  0.97    -1.89    -0.60     0.05     0.67     1.95  8429    1
# z[14,3]                    0.14    0.01  0.99    -1.76    -0.52     0.15     0.83     2.05 10363    1
# z[14,4]                    0.13    0.01  1.00    -1.84    -0.54     0.13     0.82     2.05  8785    1
# z[15,1]                   -0.32    0.01  0.94    -2.14    -0.95    -0.32     0.31     1.49  6393    1
# z[15,2]                   -0.05    0.01  0.96    -1.96    -0.69    -0.04     0.60     1.81  8660    1
# z[15,3]                   -0.09    0.01  0.93    -1.89    -0.74    -0.09     0.55     1.74  7674    1
# z[15,4]                   -0.07    0.01  1.00    -1.96    -0.75    -0.05     0.60     1.85  7345    1
# z[16,1]                    0.43    0.01  0.94    -1.44    -0.19     0.45     1.10     2.24  6818    1
# z[16,2]                   -0.07    0.01  0.98    -1.99    -0.74    -0.07     0.60     1.79  7219    1
# z[16,3]                    0.08    0.01  0.96    -1.77    -0.56     0.07     0.71     1.94  8217    1
# z[16,4]                   -0.05    0.01  0.96    -1.90    -0.69    -0.06     0.60     1.77  6352    1
# z[17,1]                   -0.31    0.01  0.94    -2.20    -0.93    -0.31     0.30     1.52  5873    1
# z[17,2]                   -0.02    0.01  0.95    -1.92    -0.63    -0.04     0.63     1.85  7455    1
# z[17,3]                   -0.10    0.01  0.96    -2.00    -0.73    -0.10     0.55     1.78  7075    1
# z[17,4]                   -0.06    0.01  0.99    -2.01    -0.73    -0.06     0.61     1.93  7982    1
# z[18,1]                    0.45    0.01  0.92    -1.37    -0.17     0.45     1.07     2.22  7600    1
# z[18,2]                   -0.10    0.01  0.94    -1.99    -0.74    -0.08     0.53     1.76  8283    1
# z[18,3]                    0.06    0.01  0.98    -1.84    -0.60     0.06     0.73     1.99  7860    1
# z[18,4]                   -0.05    0.01  0.94    -1.93    -0.66    -0.06     0.57     1.84  9587    1
# z[19,1]                   -0.31    0.01  0.95    -2.23    -0.93    -0.28     0.33     1.57  7893    1
# z[19,2]                   -0.02    0.01  0.99    -1.99    -0.70     0.00     0.65     1.88  8058    1
# z[19,3]                   -0.10    0.01  0.97    -2.03    -0.76    -0.10     0.56     1.79  7444    1
# z[19,4]                   -0.05    0.01  0.98    -1.96    -0.72    -0.05     0.61     1.87  7172    1
# z[20,1]                   -0.32    0.01  0.97    -2.20    -0.97    -0.32     0.34     1.53  8444    1
# z[20,2]                   -0.03    0.01  0.97    -1.90    -0.68    -0.03     0.62     1.84  7728    1
# z[20,3]                   -0.10    0.01  0.96    -2.01    -0.75    -0.08     0.56     1.77  6150    1
# z[20,4]                   -0.06    0.01  0.99    -2.04    -0.70    -0.06     0.58     1.89  7848    1
# [ reached getOption("max.print") -- omitted 3601 rows ]
# 
# Samples were drawn using NUTS(diag_e) at Thu Jun  4 17:37:18 2020.
# For each parameter, n_eff is a crude measure of effective sample size,
# and Rhat is the potential scale reduction factor on split chains (at 
#                                                                   convergence, Rhat=1).